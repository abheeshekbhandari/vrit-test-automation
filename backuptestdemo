from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
import string
import random
import time
import re


# ---------- Config ----------
options = Options()
options.add_experimental_option("detach", True)  # Keep Chrome open after script ends

# ---------- Helper Functions ----------
def generate_random_email():
    username = "abi_" + ''.join(random.choices(string.ascii_lowercase + string.digits, k=6))
    return f"{username}@yopmail.com"

def generate_random_nepali_phone():
    # Start with 9, then 9 random digits
    return '9801' + ''.join(random.choices('0123456789', k=6))

# Example usage
random_nepali_number = generate_random_nepali_phone()
print(random_nepali_number)

# ---------- Start WebDriver ----------
driver = webdriver.Chrome(options=options)
driver.get("https://authorized-partner.vercel.app/")
wait = WebDriverWait(driver, 15)

# ---------- Step 1: Get Started ----------
get_started_button = wait.until(
    EC.element_to_be_clickable((By.XPATH, "//button[normalize-space()='Get Started']"))
)
get_started_button.click()

# ---------- Step 2: I Agree ----------
get_iagree_button = wait.until(
    EC.element_to_be_clickable((By.XPATH, "/html/body/div[3]/div[4]/div[3]/div/button"))
)
get_iagree_button.click()

# ---------- Step 3: Continue ----------
get_continue_button = wait.until(
    EC.element_to_be_clickable((By.XPATH, "//a/button[normalize-space()='Continue']"))
)
get_continue_button.click()

# ---------- Step 4: Fill Personal Info ----------
# First Name
first_name_input = wait.until(
    EC.element_to_be_clickable((By.XPATH, "//input[@placeholder='Enter Your First Name']"))
)
first_name_input.send_keys("Abhishek")

# Last Name
last_name_input = wait.until(
    EC.element_to_be_clickable((By.XPATH, "//input[@placeholder='Enter Your Last Name']"))
)
last_name_input.send_keys("Bhandari")

# Email
email_input = wait.until(
    EC.element_to_be_clickable((By.XPATH, "//input[@type='email' or contains(@placeholder,'Email')]"))
)
email = generate_random_email()
print("Generated email:", email)
email_input.clear()
email_input.send_keys(email)

# Phone Number
# Phone Number (Nepali 10-digit format)
number_input = wait.until(
    EC.element_to_be_clickable((By.XPATH, "/html/body/div[3]/div[4]/div/div/div/div[2]/form/div[2]/div[2]/div/div/input"))
)

random_nepali_number = generate_random_nepali_phone()
print("Generated Nepali phone number:", random_nepali_number)

number_input.clear()
number_input.click()
number_input.send_keys(random_nepali_number)
time.sleep(2)

# Password
password_input = wait.until(
    EC.element_to_be_clickable((By.XPATH, "/html/body/div[3]/div[4]/div/div/div/div[2]/form/div[3]/div[1]/div[1]/input"))
)
password_input.send_keys("Testing123!")

# Confirm Password
confirm_password_input = wait.until(
    EC.element_to_be_clickable((By.XPATH, "/html/body/div[3]/div[4]/div/div/div/div[2]/form/div[3]/div[2]/div[1]/input"))
)
confirm_password_input.send_keys("Testing123!")

# Next Button
next_button_personal = wait.until(
    EC.element_to_be_clickable((By.XPATH, "//button[normalize-space()='Next']"))
)
next_button_personal.click()

print("Form filled successfully!")


# Open Yopmail in new tab
driver.execute_script("window.open('https://yopmail.com', '_blank');")
driver.switch_to.window(driver.window_handles[1])

wait = WebDriverWait(driver, 30)

# Enter inbox name (before @)
email_input = wait.until(
    EC.element_to_be_clickable(
        (By.XPATH, "/html/body/div/div[2]/main/div[3]/div/div[1]/div[2]/div/div/form/div/div[1]/div[2]/div/input")
    )
)

email_input.clear()
email_input.click()
email_input.send_keys(email)
email_input.send_keys(Keys.RETURN)

# ---------- Refresh loop until email arrives ----------

otp = None
max_attempts = 10  # maximum number of refresh attempts
attempt = 0

while not otp and attempt < max_attempts:
    attempt += 1
    try:
        # Switch to iframe containing email
        wait.until(EC.frame_to_be_available_and_switch_to_it((By.ID, "ifmail")))

        # Get email body
        email_body = wait.until(
            EC.presence_of_element_located((By.TAG_NAME, "body"))
        ).text
        print(email_body)

        # Try to extract OTP (4-6 digits)
        otp_match = re.search(r"code below:\s*(\d{4,6})", email_body, re.IGNORECASE)
        if otp_match:
            otp = otp_match.group(1)
            print("Captured OTP:", otp)
            break

    except:
        pass
    finally:
        driver.switch_to.default_content()

    # Refresh inbox if OTP not found
    print(f"OTP not found, refreshing inbox... attempt {attempt}")
    refresh_btn = wait.until(
        EC.element_to_be_clickable((By.ID, "refresh"))
    )
    refresh_btn.click()
    time.sleep(2)  # wait a bit after refresh

yopmail_input = wait.until(
    EC.element_to_be_clickable((By.XPATH, "/html/body/div/div[2]/main/div[3]/div/div[1]/div[2]/div/div/form/div/div/div[4]/button/i"))
)
yopmail_input.clear()
yopmail_input.send_keys(email)

driver.find_element(By.XPATH, "//button[@title='Check Inbox']").click()

# Switch to Yopmail email iframe
wait.until(EC.frame_to_be_available_and_switch_to_it((By.ID, "ifmail")))

# Get all <p> elements inside the email
otp_elements = driver.find_elements(By.TAG_NAME, "p")

otp = None
for elem in otp_elements:
    text = elem.text.strip()
    otp_match = re.search(r"code below:\s*(\d{4,6})", email_body, re.IGNORECASE)
    if otp_match:
        otp = otp_match.group(1)

        print("Captured OTP:", otp)
        break

driver.switch_to.default_content()  # back to main tab

if not otp:
    raise Exception("6-digit OTP not found")

# Enter OTP on main page
driver.switch_to.window(driver.window_handles[0])
wait = WebDriverWait(driver, 20)

# OTP input
otp_input = wait.until(
    EC.element_to_be_clickable((By.XPATH, "//input[@placeholder='Enter OTP']"))
)
otp_input.click()
otp_input.clear()
otp_input.send_keys(otp)
time.sleep(1)

# Verify
verify_button = wait.until(
    EC.element_to_be_clickable((By.XPATH, "//button[normalize-space()='Verify']"))
)
driver.execute_script("arguments[0].click();", verify_button)

print("âœ… OTP submitted successfully")



#Agency Detail Page

agency_name = wait.until(
    EC.visibility_of_element_located(
        (By.XPATH,"/html/body/div[3]/div[4]/div/div/div/div[2]/form/div[1]/div[1]/input")
    )
)
agency_name.send_keys("The Authorized Partner")

agency_role = wait.until(
    EC.visibility_of_element_located(
        (By.XPATH,"/html/body/div[3]/div[4]/div/div/div/div[2]/form/div[1]/div[2]/input")
    )
)
agency_role.send_keys("QA Intern")

agency_email = wait.until(
    EC.visibility_of_element_located(
        (By.XPATH,"/html/body/div[3]/div[4]/div/div/div/div[2]/form/div[2]/div[1]/input")
    )
)
agency_email.send_keys("abhibhan@yopmail.com")

agency_website = wait.until(
    EC.visibility_of_element_located(
        (By.XPATH,"/html/body/div[3]/div[4]/div/div/div/div[2]/form/div[2]/div[2]/div/input")
    )
)
agency_website.send_keys("www.linkedin.com")

agency_address = wait.until(
    EC.visibility_of_element_located(
        (By.XPATH,"/html/body/div[3]/div[4]/div/div/div/div[2]/form/div[3]/div[1]/input")
    )
)
agency_address.send_keys("Imadol,Lalitpur")

agency_region = wait.until(
    EC.element_to_be_clickable(
        (By.XPATH, "//button[@role='combobox' and .//span[text()='Select Your Region of Operation']]")
    )
)
agency_region.click()

# Click "Canada"
canada_option = wait.until(
    EC.element_to_be_clickable(
        (By.XPATH, "//div[normalize-space()='Canada']")
    )
)
canada_option.click()

next_button_agency = wait.until(
    EC.element_to_be_clickable(
        (By.XPATH,"/html/body/div[3]/div[4]/div/div/div/div[2]/form/div[4]/button[2]")
    )
)
next_button_agency.click()
